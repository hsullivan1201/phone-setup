#!/usr/bin/env bash
# spotify-connect â€” control Spotify playback via librespot + Web API
# Deployed to /usr/local/bin/spotify-connect

set -euo pipefail

CONFIG="/etc/asterisk/spotify.env"
PLAYLISTS="/etc/asterisk/spotify-playlists.conf"
TOKEN_CACHE="/var/tmp/spotify-token.json"
PID_FILE="/tmp/spotify-connect.pid"
DEVICE_NAME="Telephone"
TTS_OUT="/tmp/spotify-now-playing"

# Load config
if [[ -f "$CONFIG" ]]; then
    source "$CONFIG"
fi

########################################
# Token management
########################################

get_token() {
    # Check cache first
    if [[ -f "$TOKEN_CACHE" ]]; then
        local expires_at token
        expires_at=$(jq -r '.expires_at // 0' "$TOKEN_CACHE" 2>/dev/null)
        token=$(jq -r '.access_token // empty' "$TOKEN_CACHE" 2>/dev/null)
        if [[ -n "$token" && $(date +%s) -lt "$expires_at" ]]; then
            echo "$token"
            return
        fi
    fi

    # Refresh
    local response
    response=$(curl -s -X POST https://accounts.spotify.com/api/token \
        -d grant_type=refresh_token \
        -d "refresh_token=$SPOTIFY_REFRESH_TOKEN" \
        -u "$SPOTIFY_CLIENT_ID:$SPOTIFY_CLIENT_SECRET")

    local token expires_in
    token=$(echo "$response" | jq -r '.access_token // empty')
    expires_in=$(echo "$response" | jq -r '.expires_in // 3600')

    if [[ -z "$token" ]]; then
        echo "ERROR: Failed to get access token" >&2
        echo "$response" >&2
        return 1
    fi

    local expires_at=$(( $(date +%s) + expires_in - 60 ))  # 60s buffer
    local tmpfile="${TOKEN_CACHE}.$$"
    jq -n --arg token "$token" --arg expires_at "$expires_at" \
        '{"access_token": $token, "expires_at": ($expires_at | tonumber)}' > "$tmpfile"
    chmod 666 "$tmpfile" 2>/dev/null
    mv -f "$tmpfile" "$TOKEN_CACHE"

    echo "$token"
}

get_device_id() {
    local token="$1"
    local devices
    devices=$(curl -s "https://api.spotify.com/v1/me/player/devices" \
        -H "Authorization: Bearer $token")
    echo "$devices" | jq -r ".devices[] | select(.name == \"$DEVICE_NAME\") | .id" | head -1
}

api() {
    local method="$1" url="$2"
    shift 2
    local token
    token=$(get_token)
    curl -s -X "$method" "$url" \
        -H "Authorization: Bearer $token" \
        -H "Content-Type: application/json" \
        "$@"
}

########################################
# Commands
########################################

cmd_start() {
    # Kill any existing librespot
    pkill -x librespot 2>/dev/null || true
    rm -f "$PID_FILE"
    sleep 1

    # Launch librespot as hazel with PulseAudio
    setsid librespot -n "$DEVICE_NAME" -b 320 \
        --backend pulseaudio --volume-ctrl fixed \
        -c /home/hazel/.cache/librespot &
    echo $! > "$PID_FILE"
    disown
}

cmd_activate() {
    # Wait for device to register with Spotify, then transfer playback via API
    # so the Web API session recognizes the device as active
    local token device_id
    for i in 1 2 3 4 5; do
        sleep 1
        token=$(get_token) || continue
        device_id=$(get_device_id "$token")
        if [[ -n "$device_id" ]]; then
            curl -s -X PUT "https://api.spotify.com/v1/me/player" \
                -H "Authorization: Bearer $token" \
                -H "Content-Type: application/json" \
                -d "{\"device_ids\":[\"$device_id\"]}"
            break
        fi
    done
}

cmd_stop() {
    if [[ -f "$PID_FILE" ]]; then
        kill "$(cat "$PID_FILE" 2>/dev/null)" 2>/dev/null || true
        rm -f "$PID_FILE"
    fi
    # Belt and suspenders
    pkill -x librespot 2>/dev/null || true
}

cmd_play() {
    local token device_id
    token=$(get_token)
    device_id=$(get_device_id "$token")

    if [[ -z "$device_id" ]]; then
        echo "ERROR: Spotify device '$DEVICE_NAME' not found" >&2
        return 1
    fi

    if [[ -n "${1:-}" ]]; then
        local uri
        # If it's a 3-digit extension, look up in playlists.conf
        if [[ "$1" =~ ^[0-9]{3}$ && -f "$PLAYLISTS" ]]; then
            uri=$(grep "^$1=" "$PLAYLISTS" | head -1 | cut -d= -f2)
        else
            uri="$1"
        fi

        if [[ -z "$uri" ]]; then
            echo "ERROR: No playlist found for extension $1" >&2
            return 1
        fi

        # Start playlist, then enable shuffle and skip so it takes effect
        curl -s -X PUT "https://api.spotify.com/v1/me/player/play?device_id=$device_id" \
            -H "Authorization: Bearer $token" \
            -H "Content-Type: application/json" \
            -d "{\"context_uri\":\"$uri\"}"
        sleep 1
        curl -s -X PUT "https://api.spotify.com/v1/me/player/shuffle?state=true&device_id=$device_id" \
            -H "Authorization: Bearer $token"
        curl -s -X POST "https://api.spotify.com/v1/me/player/next?device_id=$device_id" \
            -H "Authorization: Bearer $token"
    else
        # Resume playback on device
        curl -s -X PUT "https://api.spotify.com/v1/me/player/play?device_id=$device_id" \
            -H "Authorization: Bearer $token"
    fi
}

cmd_pause() {
    local token device_id
    token=$(get_token)
    device_id=$(get_device_id "$token")

    if [[ -z "$device_id" ]]; then
        echo "ERROR: Spotify device '$DEVICE_NAME' not found" >&2
        return 1
    fi

    # Check current state to toggle
    local state
    state=$(curl -s "https://api.spotify.com/v1/me/player" \
        -H "Authorization: Bearer $token")
    local is_playing
    is_playing=$(echo "$state" | jq -r '.is_playing // false')

    if [[ "$is_playing" == "true" ]]; then
        curl -s -X PUT "https://api.spotify.com/v1/me/player/pause?device_id=$device_id" \
            -H "Authorization: Bearer $token"
    else
        curl -s -X PUT "https://api.spotify.com/v1/me/player/play?device_id=$device_id" \
            -H "Authorization: Bearer $token"
    fi
}

cmd_next() {
    local token device_id
    token=$(get_token)
    device_id=$(get_device_id "$token")
    curl -s -X POST "https://api.spotify.com/v1/me/player/next?device_id=$device_id" \
        -H "Authorization: Bearer $token"
}

cmd_prev() {
    local token device_id
    token=$(get_token)
    device_id=$(get_device_id "$token")
    curl -s -X POST "https://api.spotify.com/v1/me/player/previous?device_id=$device_id" \
        -H "Authorization: Bearer $token"
}

cmd_now_playing() {
    local token
    token=$(get_token)
    local response
    response=$(curl -s "https://api.spotify.com/v1/me/player/currently-playing" \
        -H "Authorization: Bearer $token")

    if [[ -z "$response" || "$response" == "null" ]]; then
        echo "Nothing playing"
        return
    fi

    local track artist
    track=$(echo "$response" | jq -r '.item.name // "Unknown"')
    artist=$(echo "$response" | jq -r '.item.artists[0].name // "Unknown"')
    echo "$track, by $artist"
}

cmd_now_playing_tts() {
    local info
    info=$(cmd_now_playing)

    if [[ "$info" == "Nothing playing" ]]; then
        info="Nothing is currently playing"
    else
        info="Now playing: $info"
    fi

    # Use Deepgram Aura 2 TTS, fall back to espeak-ng
    if [[ -f /etc/asterisk/deepgram.env ]]; then
        source /etc/asterisk/deepgram.env
    fi

    if [[ -n "${DEEPGRAM_API_KEY:-}" ]]; then
        curl -s "https://api.deepgram.com/v1/speak?model=aura-2-asteria-en&encoding=linear16&sample_rate=16000&container=none" \
            -H "Authorization: Token $DEEPGRAM_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$info\"}" \
            -o "${TTS_OUT}.sln16"
    else
        espeak-ng -w "${TTS_OUT}.sln16" --stdout "$info" 2>/dev/null | \
            ffmpeg -y -i - -f s16le -ar 8000 -ac 1 "${TTS_OUT}.sln16" 2>/dev/null
    fi
}

########################################
# Main
########################################

case "${1:-help}" in
    start)            cmd_start ;;
    activate)         cmd_activate ;;
    stop)             cmd_stop ;;
    play)             cmd_play "${2:-}" ;;
    pause)            cmd_pause ;;
    next)             cmd_next ;;
    prev)             cmd_prev ;;
    now-playing)      cmd_now_playing ;;
    now-playing-tts)  cmd_now_playing_tts ;;
    *)
        echo "Usage: spotify-connect {start|stop|play [ext|uri]|pause|next|prev|now-playing|now-playing-tts}"
        exit 1
        ;;
esac
