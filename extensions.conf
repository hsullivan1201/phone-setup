; Dialplan for HT701 ATA test setup
; All extensions are 3-digit: 1xx = utility, 7xx = radio

[general]
static=yes
writeprotect=no

[internal]
; =============================================
; UTILITY EXTENSIONS (1xx)
; =============================================

; 0 — shortcut to operator
exten => 0,1,Goto(internal,100,1)

; 100 — AI operator (AudioSocket to Python agent)
exten => 100,1,Answer()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000000,127.0.0.1:9092)
 same => n,Hangup()

; 101 — hear "hello world"
exten => 101,1,Answer()
 same => n,Playback(hello-world)
 same => n,Hangup()

; 102 — echo test (speak and hear yourself back)
exten => 102,1,Answer()
 same => n,Echo()

; 103 — DTMF test (enter 4 digits, hear them read back)
exten => 103,1,Answer()
 same => n,Playback(beep)
 same => n,Read(DIGITS,,4)
 same => n,SayDigits(${DIGITS})
 same => n,Hangup()

; 104 — music on hold
exten => 104,1,Answer()
 same => n,MusicOnHold(default)

; 105 — congrats demo
exten => 105,1,Answer()
 same => n,Playback(demo-congrats)
 same => n,Hangup()

; =============================================
; RADIO STATIONS (7xx, via ConfBridge)
; =============================================
; Each station uses a ConfBridge. A Local channel injects the
; stream into the bridge so the handset and speaker both hear it.
;
; DTMF keys while listening:
;   4  Now playing (TTS reads current track info)
;   5  Activate room speakers
;   6  Deactivate room speakers
;
; === CANADA ===

; 700 — CISM 89.3 (Montreal college radio)
exten => 700,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-cism)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-cism)} > 0]?join)
 same => n,Originate(Local/cism@stream-inject/n,exten,stream-bridge,cism,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-cism,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 701 — CIUT 89.5 (Toronto college radio)
exten => 701,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-ciut)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-ciut)} > 0]?join)
 same => n,Originate(Local/ciut@stream-inject/n,exten,stream-bridge,ciut,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-ciut,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 702 — CKDU 88.1 (Halifax college radio)
exten => 702,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-ckdu)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-ckdu)} > 0]?join)
 same => n,Originate(Local/ckdu@stream-inject/n,exten,stream-bridge,ckdu,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-ckdu,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; === NORTHEAST US ===

; 703 — WFMU 91.1 (NYC freeform)
exten => 703,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-wfmu)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-wfmu)} > 0]?join)
 same => n,Originate(Local/wfmu@stream-inject/n,exten,stream-bridge,wfmu,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-wfmu,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 704 — New Sounds (NYC experimental / ambient)
exten => 704,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-newsounds)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-newsounds)} > 0]?join)
 same => n,Originate(Local/newsounds@stream-inject/n,exten,stream-bridge,newsounds,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-newsounds,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 705 — WNYC 93.9 (NYC public radio)
exten => 705,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-wnyc)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-wnyc)} > 0]?join)
 same => n,Originate(Local/wnyc@stream-inject/n,exten,stream-bridge,wnyc,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-wnyc,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 706 — WMBR 88.1 (MIT college radio)
exten => 706,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-wmbr)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-wmbr)} > 0]?join)
 same => n,Originate(Local/wmbr@stream-inject/n,exten,stream-bridge,wmbr,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-wmbr,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 707 — WBUR 90.9 (Boston NPR)
exten => 707,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-wbur)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-wbur)} > 0]?join)
 same => n,Originate(Local/wbur@stream-inject/n,exten,stream-bridge,wbur,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-wbur,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; === MIDWEST ===

; 708 — CHIRP 107.1 (Chicago independent radio)
exten => 708,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-chirp)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-chirp)} > 0]?join)
 same => n,Originate(Local/chirp@stream-inject/n,exten,stream-bridge,chirp,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-chirp,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 709 — WBEZ 91.5 (Chicago NPR)
exten => 709,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-wbez)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-wbez)} > 0]?join)
 same => n,Originate(Local/wbez@stream-inject/n,exten,stream-bridge,wbez,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-wbez,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; === WEST COAST ===

; 710 — KEXP 90.3 (Seattle freeform)
exten => 710,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-kexp)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-kexp)} > 0]?join)
 same => n,Originate(Local/kexp@stream-inject/n,exten,stream-bridge,kexp,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-kexp,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 711 — KALX 90.7 (Berkeley college radio)
exten => 711,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-kalx)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-kalx)} > 0]?join)
 same => n,Originate(Local/kalx@stream-inject/n,exten,stream-bridge,kalx,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-kalx,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 712 — BFF.fm (San Francisco community radio)
exten => 712,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-bff)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-bff)} > 0]?join)
 same => n,Originate(Local/bff@stream-inject/n,exten,stream-bridge,bff,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-bff,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 713 — KQED 88.5 (San Francisco NPR)
exten => 713,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-kqed)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-kqed)} > 0]?join)
 same => n,Originate(Local/kqed@stream-inject/n,exten,stream-bridge,kqed,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-kqed,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 714 — KBOO 90.7 (Portland community radio)
exten => 714,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-kboo)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-kboo)} > 0]?join)
 same => n,Originate(Local/kboo@stream-inject/n,exten,stream-bridge,kboo,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-kboo,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 715 — XRAY.fm 91.1 (Portland freeform)
exten => 715,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-xray)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-xray)} > 0]?join)
 same => n,Originate(Local/xray@stream-inject/n,exten,stream-bridge,xray,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-xray,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; === DC / NATIONAL ===

; 716 — The Gamut / WWFD 820 AM (DC-area freeform)
exten => 716,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-gamut)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-gamut)} > 0]?join)
 same => n,Originate(Local/gamut@stream-inject/n,exten,stream-bridge,gamut,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-gamut,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 717 — WETA Classical 90.9 (Washington DC)
exten => 717,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-weta)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-weta)} > 0]?join)
 same => n,Originate(Local/weta@stream-inject/n,exten,stream-bridge,weta,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-weta,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; 718 — NPR national program stream
exten => 718,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-npr)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-npr)} > 0]?join)
 same => n,Originate(Local/npr@stream-inject/n,exten,stream-bridge,npr,1,,a)
 same => n,Wait(1)
 same => n(join),Set(TIMEOUT(digit)=5)
 same => n,ConfBridge(radio-npr,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; =============================================
; AI AGENTS (2xx)
; =============================================

; 200 — Chef (cooking advice)
exten => 200,1,Answer()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000200,127.0.0.1:9200)
 same => n,Hangup()

; 201 — Fun Facts & Stories
exten => 201,1,Answer()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000201,127.0.0.1:9201)
 same => n,Hangup()

; 202 — Librarian (book recommendations)
exten => 202,1,Answer()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000202,127.0.0.1:9202)
 same => n,Hangup()

; 203 — French Tutor (Québécois conversation)
exten => 203,1,Answer()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000203,127.0.0.1:9203)
 same => n,Hangup()

; 204 — Daily Briefing (morning news)
exten => 204,1,Answer()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000204,127.0.0.1:9204)
 same => n,Hangup()

; Hangup cleanup — stop direct speaker stream if running
exten => h,1,System(/usr/local/bin/radio-speaker stop &)

; Catch invalid extensions
exten => i,1,Playback(cannot-complete-as-dialed)
 same => n,Hangup()

; =============================================
; STREAM INJECTORS
; Local channels land here to play radio streams.
; MP3 streams use MP3Player (mpg123).
; AAC/AAC+ streams use MusicOnHold with a custom ffmpeg decoder.
; =============================================

[stream-inject]
exten => cism,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://stream03.ustream.ca:8000/cism128.mp3)
 same => n,Hangup()

exten => ckdu,1,Answer()
 same => n,Set(VOLUME(TX)=3)
 same => n,MP3Player(https://archive1.ckdu.ca:9750/ckdu_1_on_air_high.mp3)
 same => n,Hangup()

exten => wfmu,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://stream0.wfmu.org/freeform-128k)
 same => n,Hangup()

exten => newsounds,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://q2stream.wqxr.org/q2)
 same => n,Hangup()

exten => wnyc,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://fm939.wnyc.org/wnycfm)
 same => n,Hangup()

exten => wmbr,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://wmbr.org:8002/hi)
 same => n,Hangup()

exten => wbur,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://fm909.wbur.org/wbur_www)
 same => n,Hangup()

exten => chirp,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://peridot.streamguys.com:5180/backup)
 same => n,Hangup()

exten => wbez,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://stream.wbez.org/wbez128.mp3)
 same => n,Hangup()

exten => kexp,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://live-mp3-128.kexp.org/kexp128.mp3)
 same => n,Hangup()

exten => kalx,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://stream.kalx.berkeley.edu:8443/kalx-128.mp3)
 same => n,Hangup()

exten => bff,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://stream.bff.fm/1/mp3.mp3)
 same => n,Hangup()

exten => kqed,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://streams.kqed.org/kqedradio)
 same => n,Hangup()

exten => kboo,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://listen.kboo.fm:8000/high)
 same => n,Hangup()

exten => xray,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(https://listen.xray.fm/stream)
 same => n,Hangup()

exten => gamut,1,Answer()
 same => n,Set(VOLUME(TX)=3)
 same => n,MP3Player(https://playerservices.streamtheworld.com/api/livestream-redirect/WWFDAM.mp3)
 same => n,Hangup()

exten => npr,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://npr-ice.streamguys1.com/live.mp3)
 same => n,Hangup()

; --- AAC/AAC+ streams (decoded via ffmpeg) ---
exten => ciut,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MusicOnHold(radio-ciut)

exten => weta,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MusicOnHold(radio-weta)

; =============================================
; STREAM BRIDGE
; =============================================

[stream-bridge]
exten => _.,1,Answer()
 same => n,ConfBridge(radio-${EXTEN},radio_bridge,radio_user)
 same => n,Hangup()

; =============================================
; NOW PLAYING — *4 from ConfBridge DTMF menu
; =============================================

[now-playing]
exten => info,1,Set(STATION=${GLOBAL(ACTIVE_BRIDGE)})
 same => n,System(/usr/local/bin/now-playing ${STATION} --tts /tmp/now-playing-${STATION}.wav)
 same => n,Playback(/tmp/now-playing-${STATION})

; =============================================
; SPEAKER CONTROLS — *5 / *6 from ConfBridge
; =============================================

[speaker-control]
exten => on,1,NoOp(Activating speaker on bridge ${GLOBAL(ACTIVE_BRIDGE)})
 same => n,Originate(PJSIP/150,exten,speaker-join,s,1,,a)
 same => n,Playback(beep)

exten => off,1,NoOp(Deactivating speaker)
 same => n,SoftHangup(PJSIP/150,a)
 same => n,System(/usr/local/bin/radio-speaker stop &)
 same => n,Playback(beep)

[speaker-join]
exten => s,1,Answer()
 same => n,ConfBridge(${GLOBAL(ACTIVE_BRIDGE)},radio_bridge,speaker_user)
 same => n,Hangup()

; =============================================
; DIRECT SPEAKER STREAM — 7 from ConfBridge
; Plays the station webstream directly on laptop speakers
; =============================================

[speaker-stream]
exten => start,1,System(/usr/local/bin/radio-speaker start ${GLOBAL(ACTIVE_BRIDGE)} &)
 same => n,Playback(beep)

; Incoming call context
[incoming]
exten => ring100,1,Answer()
 same => n,MusicOnHold(default)

exten => alarm,1,Answer()
 same => n,Set(VOLUME(TX)=10)
 same => n,Playback(alarm)
 same => n,Playback(alarm)
 same => n,Playback(alarm)
 same => n,Hangup()
