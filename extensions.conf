; Dialplan for HT701 ATA test setup

[general]
static=yes
writeprotect=no

[internal]
; Dial 1 — hear "hello world"
exten => 1,1,Answer()
 same => n,Playback(hello-world)
 same => n,Hangup()

; Dial 2 — echo test (speak and hear yourself back)
exten => 2,1,Answer()
 same => n,Echo()

; Dial 3 — DTMF test (enter 4 digits, hear them read back)
exten => 3,1,Answer()
 same => n,Playback(beep)
 same => n,Read(DIGITS,,4)
 same => n,SayDigits(${DIGITS})
 same => n,Hangup()

; Dial 4 — music on hold
exten => 4,1,Answer()
 same => n,MusicOnHold(default)

; Dial 5 — congrats demo
exten => 5,1,Answer()
 same => n,Playback(demo-congrats)
 same => n,Hangup()

; =============================================
; RADIO STATIONS (via ConfBridge for speaker support)
; =============================================
; Each station uses a ConfBridge. A Local channel injects the
; stream into the bridge so the handset and speaker both hear it.
; Press *5 while listening to activate room speakers.
; Press *6 to deactivate speakers.

; Dial 6 — CISM 89.3 (Montreal college radio)
exten => 6,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-cism)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-cism)} > 0]?join)
 same => n,Originate(Local/cism@stream-inject/n,exten,stream-bridge,cism,1,,a)
 same => n,Wait(1)
 same => n(join),ConfBridge(radio-cism,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; Dial 7 — KEXP (Seattle)
exten => 7,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-kexp)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-kexp)} > 0]?join)
 same => n,Originate(Local/kexp@stream-inject/n,exten,stream-bridge,kexp,1,,a)
 same => n,Wait(1)
 same => n(join),ConfBridge(radio-kexp,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; Dial 8 — The Gamut
exten => 8,1,Answer()
 same => n,Set(GLOBAL(ACTIVE_BRIDGE)=radio-gamut)
 same => n,GotoIf($[${CONFBRIDGE_INFO(parties,radio-gamut)} > 0]?join)
 same => n,Originate(Local/gamut@stream-inject/n,exten,stream-bridge,gamut,1,,a)
 same => n,Wait(1)
 same => n(join),ConfBridge(radio-gamut,radio_bridge,handset_user,handset_menu)
 same => n,Hangup()

; Dial 0 — AI operator (AudioSocket to Python agent)
exten => 0,1,Answer()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000000,127.0.0.1:9092)
 same => n,Hangup()

; Catch invalid extensions
exten => i,1,Playback(cannot-complete-as-dialed)
 same => n,Hangup()

; =============================================
; STREAM INJECTORS
; Local channels land here to play radio streams.
; Audio flows through the Local channel into the ConfBridge.
; =============================================

[stream-inject]
exten => cism,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://stream03.ustream.ca:8000/cism128.mp3)
 same => n,Hangup()

exten => kexp,1,Answer()
 same => n,Set(VOLUME(TX)=6)
 same => n,MP3Player(http://live-mp3-128.kexp.org/kexp128.mp3)
 same => n,Hangup()

exten => gamut,1,Answer()
 same => n,Set(VOLUME(TX)=3)
 same => n,MP3Player(https://playerservices.streamtheworld.com/api/livestream-redirect/WWFDAM.mp3)
 same => n,Hangup()

; =============================================
; STREAM BRIDGE
; The other leg of the Local channel joins the ConfBridge here.
; This is the endpoint that actually sits in the bridge and
; carries the stream audio from the injector.
; =============================================

[stream-bridge]
exten => _.,1,Answer()
 same => n,ConfBridge(radio-${EXTEN},radio_bridge,radio_user)
 same => n,Hangup()

; =============================================
; SPEAKER CONTROLS
; Called from the ConfBridge DTMF menu (handset_menu)
; =============================================

[speaker-control]
; *5 — activate speaker (call baresip, add to current bridge)
exten => on,1,NoOp(Activating speaker on bridge ${GLOBAL(ACTIVE_BRIDGE)})
 same => n,Originate(PJSIP/150,exten,speaker-join,s,1,,a)
 same => n,Playback(beep)
 same => n,Return()

; *6 — deactivate speaker (hang up baresip)
exten => off,1,NoOp(Deactivating speaker)
 same => n,SoftHangup(PJSIP/150,a)
 same => n,Playback(beep)
 same => n,Return()

; =============================================
; SPEAKER JOIN
; baresip lands here after being originated by *5
; =============================================

[speaker-join]
exten => s,1,Answer()
 same => n,ConfBridge(${GLOBAL(ACTIVE_BRIDGE)},radio_bridge,speaker_user)
 same => n,Hangup()

; Incoming call context — triggered via CLI originate
[incoming]
exten => ring100,1,Answer()
 same => n,MusicOnHold(default)
